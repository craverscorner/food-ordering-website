"use strict";(self.webpackChunkfood_ordering_client=self.webpackChunkfood_ordering_client||[]).push([[914],{4533:(e,n,t)=>{t.r(n),t.d(n,{default:()=>D});var r=t(2555),i=t(5043),s=t(6446),a=t(5865),o=t(547),l=t(1906),c=t(1637),d=t(9252),u=t(794),m=t(8903),h=t(2110),x=t(6494),y=t(7392),p=t(5795),j=t(1787),A=t(9336),f=t(35),v=t(6600),g=t(5316),b=t(3193),C=t(9190),w=t(9285),S=t(2143),P=t(9347),_=t(5169),N=t(3216),k=t(3471),I=t(2505),B=t(6164),q=t(9669),E=t(3395),T=t(9778),G=t(1528),W=t(9677),F=t(3393),O=t(8729),M=t(579);const R=(0,W.c)("pk_live_51OwkuOP1ZtCJfXVW0FBHdfBnAo20fxfcQn3BIhBGrLhwT8N8Wg63wo3xVeM5RBPb74ATFlblRLawwiBptNauajHP00l5LoeOzz"),z=e=>{let{userInfo:n,onSuccess:t,onError:r,totalPence:d}=e;const u=(0,F.useStripe)(),m=(0,F.useElements)(),[h,x]=(0,i.useState)(null),[y,p]=(0,i.useState)(!1),[j,A]=(0,i.useState)(null),[f,v]=(0,i.useState)(!1);(0,i.useEffect)((()=>{if(u&&d>0){const e=u.paymentRequest({country:"GB",currency:"gbp",total:{label:"Total",amount:d},requestPayerName:!0,requestPayerEmail:!0});e.canMakePayment().then((n=>{n&&A(e)}))}}),[u,d]);return(0,M.jsxs)(s.A,{sx:{width:"100%"},children:[j?(0,M.jsxs)(s.A,{sx:{mb:2},children:[(0,M.jsx)(F.PaymentRequestButtonElement,{options:{paymentRequest:j}}),(0,M.jsx)(a.A,{variant:"body2",sx:{mt:1},children:"You can pay with Apple Pay or Google Pay if available on your device/browser."})]}):null,(0,M.jsxs)("form",{onSubmit:async e=>{if(e.preventDefault(),u&&m){p(!0),x(null);try{const{error:e}=await u.confirmPayment({elements:m,confirmParams:{return_url:"".concat(window.location.origin,"/success"),receipt_email:n.email,shipping:{name:n.name,address:{line1:n.address,city:n.city,postal_code:n.postalCode,country:n.country}}}});e?(x(e.message),r(e)):t()}catch(i){x(i.message),r(i)}finally{p(!1)}}else x("Please wait while we load the payment form...")},style:{width:"100%"},children:[(0,M.jsx)(s.A,{sx:{mb:2},children:(0,M.jsx)(F.PaymentElement,{onReady:()=>{console.log("PaymentElement is ready"),v(!0)},onChange:e=>{console.log("PaymentElement changed:",e),x(null)},options:{layout:{type:"tabs",defaultCollapsed:!1}}})}),h&&(0,M.jsx)(o.A,{severity:"error",sx:{mt:2},children:h}),(0,M.jsx)(l.A,{type:"submit",variant:"contained",color:"primary",fullWidth:!0,disabled:y||!f,sx:{mt:2},children:y?(0,M.jsx)(c.A,{size:24}):"Pay Now"})]})]})},D=()=>{const{cart:e,removeFromCart:n,updateQuantity:t,clearCart:W}=(0,_._)(),D=(0,N.Zp)(),{user:L}=(0,O.A)(),[U,H]=(0,i.useState)(""),[Y,J]=(0,i.useState)(!1),[Q,V]=(0,i.useState)(""),[Z,K]=(0,i.useState)(null),[X,$]=(0,i.useState)(""),[ee,ne]=(0,i.useState)(!1),[te,re]=(0,i.useState)(null),[ie,se]=(0,i.useState)(null),[ae,oe]=(0,i.useState)(!1),[le,ce]=(0,i.useState)(null),[de,ue]=(0,i.useState)({name:"",email:"",phone:"",address:"",city:"",postalCode:"",country:"GB"}),me=()=>Number(e.reduce(((e,n)=>{const t=Number(n.price)*Number(n.quantity);return e+Number(t.toFixed(2))}),0).toFixed(2)),he=e=>{if(!e)return 0;const n=me();let t=0;return"percentage"===e.discount_type?(t=Number((n*Number(e.discount_value)/100).toFixed(2)),e.max_discount&&(t=Math.min(t,Number(e.max_discount)))):t=Math.min(Number(e.discount_value),n),Number(t.toFixed(2))},xe=()=>{const e=me(),n=he(Z||ie);return Number((e-n).toFixed(2))},ye=e=>{const n=Math.round(100*Number(e));if(!Number.isInteger(n)||n<0)throw new Error("Invalid amount: ".concat(e));return n},pe=(0,i.useCallback)((async e=>{if(!e)return re(null),$(""),void se(null);ne(!0);try{const{data:n,error:t}=await q.N.from("coupons").select("*").ilike("code",e.toUpperCase()).eq("is_active",!0).single();if(t){if("PGRST116"!==t.code)throw t;return re("invalid"),$("Invalid coupon code"),void se(null)}if(!n)return re("invalid"),$("Invalid coupon code"),void se(null);const r=new Date,i=new Date(n.start_date),s=new Date(n.end_date);if(r<i||r>s)return re("invalid"),$("Coupon is not valid at this time"),void se(null);const a=me();if(n.min_order_amount&&a<n.min_order_amount)return re("invalid"),$("Minimum order amount is \xa3".concat(n.min_order_amount)),void se(null);re("valid"),$(""),se(n)}catch(n){console.error("Coupon check error:",n),re("invalid"),$(n.message),se(null)}finally{ne(!1)}}),[e]);(0,i.useEffect)((()=>{const e=setTimeout((()=>{pe(Q)}),500);return()=>clearTimeout(e)}),[Q,pe]);const je=async()=>{"valid"===te&&K(ie)},Ae=e=>n=>{ue((t=>(0,r.A)((0,r.A)({},t),{},{[e]:n.target.value})))};if(0===e.length)return(0,M.jsx)(d.A,{children:(0,M.jsxs)(s.A,{sx:{textAlign:"center",py:4},children:[(0,M.jsx)(a.A,{variant:"h5",children:"Your cart is empty"}),(0,M.jsx)(l.A,{variant:"contained",color:"primary",onClick:()=>D("/"),sx:{mt:2},children:"Continue Shopping"})]})});const fe=me(),ve=he(Z||ie),ge=xe(),be=Math.round(100*ge);return(0,M.jsxs)(d.A,{children:[(0,M.jsx)(a.A,{variant:"h4",sx:{my:4},children:"Your Cart"}),(0,M.jsx)(u.A,{open:!!U,autoHideDuration:6e3,onClose:()=>H(""),anchorOrigin:{vertical:"top",horizontal:"center"},children:(0,M.jsx)(o.A,{onClose:()=>H(""),severity:"error",sx:{width:"100%"},children:U})}),(0,M.jsxs)(m.Ay,{container:!0,spacing:3,children:[(0,M.jsx)(m.Ay,{item:!0,xs:12,md:8,children:e.map((e=>(0,M.jsx)(h.A,{sx:{mb:2},children:(0,M.jsx)(x.A,{children:(0,M.jsxs)(m.Ay,{container:!0,alignItems:"center",spacing:2,children:[(0,M.jsx)(m.Ay,{item:!0,xs:12,sm:3,children:e.image_url&&(0,M.jsx)("img",{src:e.image_url,alt:e.name,style:{width:"100%",height:"auto",borderRadius:"4px"}})}),(0,M.jsxs)(m.Ay,{item:!0,xs:12,sm:5,children:[(0,M.jsx)(a.A,{variant:"h6",children:e.name}),(0,M.jsx)(a.A,{variant:"body2",color:"text.secondary",children:void 0!==e.price&&null!==e.price?e.price.toLocaleString("en-GB",{style:"currency",currency:"GBP"}):""})]}),(0,M.jsx)(m.Ay,{item:!0,xs:12,sm:2,children:(0,M.jsxs)(s.A,{sx:{display:"flex",alignItems:"center"},children:[(0,M.jsx)(y.A,{onClick:()=>t(e.id,e.quantity-1),disabled:e.quantity<=1,children:(0,M.jsx)(B.A,{})}),(0,M.jsx)(a.A,{sx:{mx:1},children:e.quantity}),(0,M.jsx)(y.A,{onClick:()=>t(e.id,e.quantity+1),children:(0,M.jsx)(I.A,{})})]})}),(0,M.jsx)(m.Ay,{item:!0,xs:12,sm:2,sx:{textAlign:"right"},children:(0,M.jsx)(y.A,{color:"error",onClick:()=>n(e.id),children:(0,M.jsx)(k.A,{})})})]})})},e.id)))}),(0,M.jsx)(m.Ay,{item:!0,xs:12,md:4,children:(0,M.jsx)(h.A,{children:(0,M.jsxs)(x.A,{children:[(0,M.jsx)(a.A,{variant:"h6",gutterBottom:!0,children:"Order Summary"}),(0,M.jsxs)(s.A,{sx:{mb:2},children:[(0,M.jsx)(p.A,{fullWidth:!0,label:"Coupon Code",value:Q,onChange:e=>V(e.target.value),error:"invalid"===te,helperText:X,disabled:!!Z,InputProps:{endAdornment:(0,M.jsx)(j.A,{position:"end",children:ee?(0,M.jsx)(c.A,{size:20}):"valid"===te?(0,M.jsx)(y.A,{onClick:je,color:"success",children:(0,M.jsx)(T.A,{})}):"invalid"===te?(0,M.jsx)(y.A,{color:"error",children:(0,M.jsx)(G.A,{})}):(0,M.jsx)(y.A,{onClick:je,disabled:!Q,children:(0,M.jsx)(E.A,{})})})}}),(Z||ie)&&(0,M.jsxs)(s.A,{sx:{mt:1,p:1,bgcolor:"success.light",borderRadius:1},children:[(0,M.jsxs)(s.A,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,M.jsxs)(a.A,{variant:"body2",color:"success.contrastText",children:["Coupon ",Z?"applied":"available",": ",(Z||ie).code]}),Z&&(0,M.jsx)(y.A,{size:"small",onClick:()=>{K(null),se(null),V(""),re(null),$("")},sx:{color:"success.contrastText"},children:(0,M.jsx)(k.A,{fontSize:"small"})})]}),(0,M.jsx)(a.A,{variant:"body2",color:"success.contrastText",children:"percentage"===(Z||ie).discount_type?"".concat((Z||ie).discount_value,"% off"):"\xa3".concat((Z||ie).discount_value," off")})]})]}),(0,M.jsx)(A.A,{sx:{my:2}}),(0,M.jsxs)(s.A,{sx:{mt:2},children:[(0,M.jsxs)(s.A,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[(0,M.jsx)(a.A,{variant:"body1",children:"Subtotal:"}),(0,M.jsx)(a.A,{variant:"body1",children:fe.toLocaleString("en-GB",{style:"currency",currency:"GBP"})})]}),(Z||ie)&&(0,M.jsxs)(s.A,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[(0,M.jsx)(a.A,{variant:"body1",color:"success.main",children:"Discount:"}),(0,M.jsxs)(a.A,{variant:"body1",color:"success.main",children:["-",ve.toLocaleString("en-GB",{style:"currency",currency:"GBP"})]})]}),(0,M.jsx)(A.A,{sx:{my:1}}),(0,M.jsxs)(s.A,{sx:{display:"flex",justifyContent:"space-between",mb:2},children:[(0,M.jsx)(a.A,{variant:"h6",children:"Total:"}),(0,M.jsx)(a.A,{variant:"h6",children:ge.toLocaleString("en-GB",{style:"currency",currency:"GBP"})})]}),(0,M.jsx)(l.A,{variant:"contained",color:"primary",fullWidth:!0,onClick:async()=>{try{J(!0),H("");const{data:{user:n}}=await q.N.auth.getUser(),t=me(),i=Z||ie,s=he(i),a=xe();if(t<=0)throw new Error("Invalid order amount");if(s<0||s>t)throw new Error("Invalid discount amount");if(a<=0)throw new Error("Invalid total amount");const o=e.map((e=>{const n=parseFloat(e.price),t=parseInt(e.quantity);if(isNaN(n)||n<0)throw new Error("Invalid price for item ".concat(e.name));if(isNaN(t)||t<1)throw new Error("Invalid quantity for item ".concat(e.name));return(0,r.A)((0,r.A)({},e),{},{price:n.toFixed(2),quantity:t})})),l=ye(t),c=ye(s),d=Math.round(100*a),u=await fetch("http://localhost:3001/api/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({items:o,userId:(null===n||void 0===n?void 0:n.id)||null,couponId:(null===i||void 0===i?void 0:i.id)||null,subtotal:l,discount:c,total:d,isGuestCheckout:!n,userInfo:de})});if(!u.ok){const e=await u.json().catch((()=>({})));throw new Error(e.error||e.message||"HTTP error! status: ".concat(u.status))}const m=await u.json();if(!m.clientSecret)throw new Error("No client secret received from server");ce(m.clientSecret),oe(!0)}catch(U){console.error("Checkout error:",U),H(U.message||"Failed to process checkout. Please try again.")}finally{J(!1)}},disabled:Y,sx:{mt:2},children:Y?"Processing...":"Checkout"})]})]})})})]}),(0,M.jsxs)(f.A,{open:ae,onClose:()=>oe(!1),maxWidth:"md",fullWidth:!0,children:[(0,M.jsx)(v.A,{children:"Complete Your Order"}),(0,M.jsx)(g.A,{children:(0,M.jsxs)(m.Ay,{container:!0,spacing:3,children:[(0,M.jsxs)(m.Ay,{item:!0,xs:12,md:6,children:[(0,M.jsx)(a.A,{variant:"h6",gutterBottom:!0,children:"Contact Information"}),(0,M.jsx)(p.A,{fullWidth:!0,label:"Full Name",value:de.name,onChange:Ae("name"),margin:"normal",required:!0}),(0,M.jsx)(p.A,{fullWidth:!0,label:"Email",type:"email",value:de.email,onChange:Ae("email"),margin:"normal",required:!0}),(0,M.jsx)(p.A,{fullWidth:!0,label:"Phone",value:de.phone,onChange:Ae("phone"),margin:"normal",required:!0})]}),(0,M.jsxs)(m.Ay,{item:!0,xs:12,md:6,children:[(0,M.jsx)(a.A,{variant:"h6",gutterBottom:!0,children:"Delivery Address"}),(0,M.jsx)(p.A,{fullWidth:!0,label:"Address",value:de.address,onChange:Ae("address"),margin:"normal",required:!0}),(0,M.jsx)(p.A,{fullWidth:!0,label:"City",value:de.city,onChange:Ae("city"),margin:"normal",required:!0}),(0,M.jsx)(p.A,{fullWidth:!0,label:"Postal Code",value:de.postalCode,onChange:Ae("postalCode"),margin:"normal",required:!0}),(0,M.jsxs)(b.A,{fullWidth:!0,margin:"normal",children:[(0,M.jsx)(C.A,{children:"Country"}),(0,M.jsxs)(w.A,{value:de.country,onChange:Ae("country"),label:"Country",required:!0,children:[(0,M.jsx)(S.A,{value:"GB",children:"United Kingdom"}),(0,M.jsx)(S.A,{value:"US",children:"United States"})]})]})]}),(0,M.jsxs)(m.Ay,{item:!0,xs:12,children:[(0,M.jsx)(a.A,{variant:"h6",gutterBottom:!0,children:"Payment Information"}),le&&(0,M.jsx)(F.Elements,{stripe:R,options:{clientSecret:le,appearance:{theme:"stripe",variables:{colorPrimary:"#1976d2"}}},children:(0,M.jsx)(z,{userInfo:de,onSuccess:async()=>{try{J(!0);const e=await fetch("http://localhost:3001/api/confirm-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentMethodId:null,clientSecret:le,userInfo:de})}),n=await e.json();if(!e.ok)throw new Error(n.error||"Payment failed");W(),oe(!1),D("/success")}catch(U){H(U.message)}finally{J(!1)}},onError:e=>{H(e.message)},totalPence:be})})]})]})}),(0,M.jsx)(P.A,{children:(0,M.jsx)(l.A,{onClick:()=>oe(!1),children:"Cancel"})})]})]})}}}]);
//# sourceMappingURL=914.30260ee1.chunk.js.map